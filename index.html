<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTI Monitor (Safe Mode)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    #error { color: #b00020; margin: 12px 0; display:none; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 14px; }
    tr:nth-child(even) { background: #fafafa; }
    .ok { background: #f2fff2; }
    .issue { background: #fff1f3; }
  </style>
</head>
<body>
  <h1>RTI Monitor（安全模式）</h1>
  <button id="reload">重新載入</button>
  <div id="meta"></div>
  <div id="error"></div>
  <table id="tbl">
    <thead>
      <tr>
        <th>timestamp</th>
        <th>date</th>
        <th>lang</th>
        <th>program_title</th>
        <th>episode_title</th>
        <th>audio_ok</th>
        <th>bulletin_ok</th>
        <th>status</th>
        <th>issues</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const LATEST = 'latest.json';

    async function load() {
      const error = document.getElementById('error');
      error.style.display = 'none';
      error.textContent = '';

      try {
        const resp = await fetch(`${LATEST}?ts=${Date.now()}`, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const rows = await resp.json();
        if (!Array.isArray(rows)) throw new Error('latest.json 格式錯誤（非陣列）');

        const meta = document.getElementById('meta');
        meta.innerHTML = `筆數：<b>${rows.length}</b>`;

        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        for (const r of rows) {
          const tr = document.createElement('tr');
          const s = String(r.status || '').toUpperCase();
          if (s === 'OK') tr.classList.add('ok');
          else if (s === 'ISSUE') tr.classList.add('issue');

          tr.innerHTML = `
            <td>${r.timestamp ?? ''}</td>
            <td>${r.date ?? ''}</td>
            <td>${r.lang ?? ''}</td>
            <td>${r.program_title ?? ''}</td>
            <td>${r.episode_title ?? ''}</td>
            <td>${r.audio_ok}</td>
            <td>${r.bulletin_ok}</td>
            <td>${r.status ?? ''}</td>
            <td>${r.issues ?? ''}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
        error.style.display = 'block';
        error.textContent = '⚠️ 無法載入 latest.json：' + (e && e.message ? e.message : e);
      }
    }

    document.getElementById('reload').addEventListener('click', load);
    load();
  </script>
</body>
</html>
